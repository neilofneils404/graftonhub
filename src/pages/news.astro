---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/global.css';
---

<BaseLayout 
  title="Local News" 
  description="Local news and updates for Grafton, LaGrange, and Lorain County, Ohio from trusted sources like Chronicle-Telegram and Morning Journal."
>
  <section class="news-page">
    <div class="container">
      <div class="news-header">
        <h1>Local News</h1>
        <p class="news-subtitle">Stay informed with news from Grafton and Lorain County</p>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="filter-chips">
          <button class="filter-chip active" data-filter="all">All News</button>
          <button class="filter-chip" data-filter="grafton">Grafton</button>
          <button class="filter-chip" data-filter="weather">Weather</button>
          <button class="filter-chip" data-filter="schools">Schools</button>
        </div>
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search news..." aria-label="Search news">
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading news...</p>
      </div>

      <!-- Error State -->
      <div id="error" class="error-message" style="display: none;">
        <p>Unable to load news at this time. Please try again later.</p>
      </div>

      <!-- News Feed -->
      <div id="news-feed" class="news-grid" style="display: none;">
        <!-- Cards will be inserted here by JavaScript -->
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display: none;">
        <p>No news found matching your search.</p>
      </div>

      <!-- Source Attribution -->
      <div class="news-sources">
        <p><strong>News Sources:</strong> <a href="https://www.morningjournal.com" target="_blank" rel="noopener">Lorain Morning Journal</a> • <a href="https://www.chroniclet.com" target="_blank" rel="noopener">Chronicle-Telegram</a> • <a href="https://www.cleveland.com/lorain" target="_blank" rel="noopener">Cleveland.com Lorain</a></p>
        <p class="news-disclaimer">Headlines and excerpts provided by local news sources. Click "Read More" for full articles.</p>
      </div>
    </div>
  </section>

  <!-- RSS Parser Library -->
  <script src="https://cdn.jsdelivr.net/npm/rss-parser@3.13.0/dist/rss-parser.min.js"></script>

  <script>
    // RSS Feed URLs
    const RSS_FEEDS = [
      { 
        url: 'https://www.morningjournal.com/feed/', 
        name: 'Morning Journal',
        priority: 1
      },
      { 
        url: 'https://www.chroniclet.com/feed/', 
        name: 'Chronicle-Telegram',
        priority: 1
      },
      { 
        url: 'https://www.cleveland.com/lorain/index.rss', 
        name: 'Cleveland.com',
        priority: 2
      }
    ];

    // Keywords for relevance filtering
    const RELEVANCE_KEYWORDS = [
      'grafton', 'lagrange', 'elyria', 'lorain', 'oberlin', 
      'midview', 'carlisle', 'eaton', 'lorain county'
    ];

    let allArticles = [];
    let filteredArticles = [];
    let currentFilter = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadNews();
      setupEventListeners();
    });

    // Load news from RSS feeds
    async function loadNews() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const feed = document.getElementById('news-feed');

      try {
        const parser = new RSSParser({
          customFields: {
            item: [
              ['media:content', 'media'],
              ['media:thumbnail', 'thumbnail'],
              ['enclosure', 'enclosure']
            ]
          }
        });

        // Fetch all feeds in parallel
        const feedPromises = RSS_FEEDS.map(async (feedConfig) => {
          try {
            // Use CORS proxy for feeds
            const corsProxy = 'https://api.allorigins.win/raw?url=';
            const feed = await parser.parseURL(corsProxy + encodeURIComponent(feedConfig.url));
            
            return feed.items.map(item => ({
              title: item.title || 'Untitled',
              link: item.link || '#',
              description: cleanDescription(item.contentSnippet || item.description || ''),
              image: extractImage(item),
              pubDate: item.pubDate ? new Date(item.pubDate) : new Date(),
              source: feedConfig.name,
              priority: feedConfig.priority,
              categories: extractCategories(item)
            }));
          } catch (err) {
            console.error(`Failed to load ${feedConfig.name}:`, err);
            return [];
          }
        });

        const results = await Promise.all(feedPromises);
        allArticles = results.flat();

        // Filter for relevance (Grafton/Lorain County focus)
        allArticles = allArticles.filter(article => isRelevant(article));

        // Sort by date (newest first)
        allArticles.sort((a, b) => b.pubDate - a.pubDate);

        // Limit to most recent 30 articles
        allArticles = allArticles.slice(0, 30);

        if (allArticles.length === 0) {
          loading.style.display = 'none';
          error.style.display = 'block';
          return;
        }

        filteredArticles = [...allArticles];
        renderNews();

        loading.style.display = 'none';
        feed.style.display = 'grid';

      } catch (err) {
        console.error('Error loading news:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
      }
    }

    // Check if article is relevant to our area
    function isRelevant(article) {
      const searchText = `${article.title} ${article.description}`.toLowerCase();
      return RELEVANCE_KEYWORDS.some(keyword => searchText.includes(keyword));
    }

    // Extract image from RSS item
    function extractImage(item) {
      // Try various image fields
      if (item.enclosure?.url && item.enclosure.url.match(/\.(jpg|jpeg|png|webp)/i)) {
        return item.enclosure.url;
      }
      if (item.thumbnail?.$ && item.thumbnail.$.url) {
        return item.thumbnail.$.url;
      }
      if (item.media?.$ && item.media.$.url) {
        return item.media.$.url;
      }
      // Fallback placeholder
      return '/placeholder-news.svg';
    }

    // Clean description text
    function cleanDescription(desc) {
      // Strip HTML tags and limit length
      const text = desc.replace(/<[^>]*>/g, '').trim();
      return text.length > 200 ? text.substring(0, 200) + '...' : text;
    }

    // Extract categories from article
    function extractCategories(item) {
      const cats = [];
      const text = `${item.title} ${item.description || ''}`.toLowerCase();
      
      if (text.includes('school') || text.includes('education') || text.includes('midview') || text.includes('student')) {
        cats.push('schools');
      }
      if (text.includes('weather') || text.includes('storm') || text.includes('snow') || text.includes('rain')) {
        cats.push('weather');
      }
      if (text.includes('grafton')) {
        cats.push('grafton');
      }
      
      return cats;
    }

    // Render news cards
    function renderNews() {
      const feed = document.getElementById('news-feed');
      const emptyState = document.getElementById('empty-state');

      if (filteredArticles.length === 0) {
        feed.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      feed.style.display = 'grid';

      feed.innerHTML = filteredArticles.map(article => `
        <article class="news-card">
          <div class="news-card-image">
            <img src="${article.image}" alt="${article.title}" loading="lazy" onerror="this.src='/placeholder-news.svg'">
          </div>
          <div class="news-card-content">
            <div class="news-card-meta">
              <span class="news-source">${article.source}</span>
              <span class="news-date">${formatDate(article.pubDate)}</span>
            </div>
            <h3 class="news-card-title">
              <a href="${article.link}" target="_blank" rel="noopener">${article.title}</a>
            </h3>
            <p class="news-card-description">${article.description}</p>
            <div class="news-card-footer">
              ${article.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
              <a href="${article.link}" target="_blank" rel="noopener" class="read-more">Read More →</a>
            </div>
          </div>
        </article>
      `).join('');
    }

    // Format date for display
    function formatDate(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      if (diffHours < 1) return 'Just now';
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Filter chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          currentFilter = chip.dataset.filter;
          applyFilters();
        });
      });

      // Search input
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', debounce(() => {
        applyFilters();
      }, 300));
    }

    // Apply filters and search
    function applyFilters() {
      const searchQuery = document.getElementById('search-input').value.toLowerCase();
      
      filteredArticles = allArticles.filter(article => {
        // Category filter
        if (currentFilter !== 'all' && !article.categories.includes(currentFilter)) {
          return false;
        }

        // Search filter
        if (searchQuery) {
          const searchText = `${article.title} ${article.description}`.toLowerCase();
          if (!searchText.includes(searchQuery)) {
            return false;
          }
        }

        return true;
      });

      renderNews();
    }

    // Debounce helper
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>

  <style>
    .news-page {
      padding: var(--space-2xl) 0;
    }

    .news-header {
      text-align: center;
      margin-bottom: var(--space-2xl);
    }

    .news-header h1 {
      font-size: var(--font-size-3xl);
      color: var(--color-text);
      margin-bottom: var(--space-sm);
    }

    .news-subtitle {
      color: var(--color-text-secondary);
      font-size: var(--font-size-lg);
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-chips {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-lg);
      background: var(--color-bg);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-chip:hover {
      background: var(--color-bg-alt);
      border-color: var(--color-primary);
    }

    .filter-chip.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-lg);
      font-size: var(--font-size-base);
      background: var(--color-bg);
      color: var(--color-text);
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: var(--space-3xl) 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto var(--space-md);
      border: 4px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error State */
    .error-message {
      text-align: center;
      padding: var(--space-3xl);
      color: var(--color-error);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-3xl);
      color: var(--color-text-secondary);
    }

    /* News Grid */
    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: var(--space-xl);
      margin-bottom: var(--space-2xl);
    }

    /* News Card */
    .news-card {
      background: var(--color-bg-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .news-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .news-card-image {
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: var(--color-bg-alt);
    }

    .news-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .news-card-content {
      padding: var(--space-lg);
    }

    .news-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
    }

    .news-source {
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
    }

    .news-card-title {
      font-size: var(--font-size-lg);
      line-height: var(--line-height-tight);
      margin-bottom: var(--space-md);
    }

    .news-card-title a {
      color: var(--color-text);
      text-decoration: none;
    }

    .news-card-title a:hover {
      color: var(--color-primary);
      text-decoration: underline;
    }

    .news-card-description {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--space-md);
    }

    .news-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .category-tag {
      display: inline-block;
      padding: 2px 8px;
      background: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-transform: capitalize;
    }

    .read-more {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      white-space: nowrap;
    }

    /* Sources */
    .news-sources {
      text-align: center;
      padding: var(--space-xl);
      border-top: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .news-disclaimer {
      margin-top: var(--space-sm);
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
    }

    /* Dark Mode Adjustments */
    [data-theme="dark"] .news-card {
      background: var(--color-bg-surface);
    }

    [data-theme="dark"] .search-box input {
      background: var(--color-bg-surface);
      color: var(--color-text);
    }

    [data-theme="dark"] .category-tag {
      background: var(--color-bg-alt);
      border-color: var(--color-border);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .news-grid {
        grid-template-columns: 1fr;
        gap: var(--space-lg);
      }

      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        width: 100%;
      }
    }
  </style>
</BaseLayout>
